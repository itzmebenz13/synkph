<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MailDot Gen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <meta name="theme-color" content="#ffffff">

    <!-- Theme Init (No Flash) -->
    <script>
        if (localStorage.getItem('shein_pcal_theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Roboto+Mono:wght@400;500&display=swap');

        /* Defaults */
        body { font-family: 'Inter', sans-serif; background-color: #f6f6f6; transition: background-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        
        /* Dark Mode */
        html.dark-mode body { background-color: #121212; color: #ffffff; }
        html.dark-mode .bg-white { background-color: #1e1e1e !important; color: #ffffff !important; border-color: #333 !important; }
        html.dark-mode .bg-gray-50, html.dark-mode .bg-gray-100 { background-color: #181818 !important; color: #e5e5e5 !important; border-color: #333 !important; }
        html.dark-mode .text-gray-600, html.dark-mode .text-gray-500, html.dark-mode .text-gray-400 { color: #a3a3a3 !important; }
        html.dark-mode .text-black, html.dark-mode .text-gray-800 { color: #ffffff !important; }
        html.dark-mode input, html.dark-mode select { background-color: transparent; color: white; border-color: #444; }
        html.dark-mode .border-gray-200, html.dark-mode .border-gray-300 { border-color: #333 !important; }
        html.dark-mode .stat-card { background-color: #1e1e1e; border-color: #333; }
        html.dark-mode textarea { background-color: #262626; color: white; border-color: #444; }

        /* Custom Inputs */
        .md-input {
            width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;
            font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .md-input:focus { border-color: #000; }
        html.dark-mode .md-input:focus { border-color: #fff; }

        /* Email Item */
        .email-item {
            display: flex; flex-direction: column; gap: 8px;
            padding: 12px; background: white; border-radius: 8px;
            border: 1px solid #e5e7eb; margin-bottom: 8px;
            transition: all 0.2s;
        }
        .email-text {
            font-family: 'Roboto Mono', monospace; font-size: 13px; font-weight: 500;
            cursor: pointer; word-break: break-all; color: #333;
            padding: 4px 0; display: block;
        }
        html.dark-mode .email-text { color: #e5e5e5; }
        .email-text.copied { color: #16a34a !important; } /* Green when copied */

        /* Controls Row */
        .item-controls { display: flex; gap: 8px; align-items: center; }
        .tiny-input {
            padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 11px;
            width: 80px; background: transparent;
        }
        
        /* Status Toggle */
        .status-btn {
            font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 4px;
            text-transform: uppercase; cursor: pointer; border: 1px solid;
            width: 60px; text-align: center;
        }
        .status-active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .status-sold { background-color: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }
        html.dark-mode .status-active { background-color: #172554; color: #93c5fd; border-color: #1e3a8a; }
        html.dark-mode .status-sold { background-color: #052e16; color: #86efac; border-color: #14532d; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px; }
        .stat-card { background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .stat-val { font-size: 18px; font-weight: 900; }
        .stat-lbl { font-size: 10px; text-transform: uppercase; color: #6b7280; font-weight: 600; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-card {
            background: white; width: 90%; max-width: 320px; border-radius: 12px;
            padding: 20px; transform: translateY(20px); transition: transform 0.2s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-overlay.show .modal-card { transform: translateY(0); }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div class="max-w-md mx-auto bg-gray-50 min-h-screen relative shadow-2xl">
        
        <!-- Header -->
        <header class="bg-white sticky top-0 z-50 px-4 py-3 shadow-sm flex items-center justify-between border-b border-gray-100">
            <div class="flex items-center gap-2">
                <a href="index.html" class="text-xl text-gray-800"><i class="fas fa-chevron-left"></i></a>
                <h1 class="text-lg font-black italic tracking-tighter">Mail<span class="text-blue-600">Dot</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <button class="text-gray-600 hover:text-blue-600 transition-colors" id="btn-data" title="Backup/Restore">
                    <i class="fas fa-database"></i>
                </button>
                <button class="text-gray-600 hover:text-black transition-colors" id="btn-theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <main class="p-4">
            
            <!-- Dashboard Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-lbl">Today's Earnings</div>
                    <div class="stat-val text-green-600" id="stat-today">₱0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Accounts Made</div>
                    <div class="stat-val text-blue-600" id="stat-accounts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">This Week</div>
                    <div class="stat-val" id="stat-week">₱0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">All Time</div>
                    <div class="stat-val" id="stat-total">₱0.00</div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4">
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Email Address</label>
                <input type="email" id="input-email" class="md-input mb-3" placeholder="example@gmail.com">
                
                <div class="flex gap-2 mb-3">
                    <div class="w-1/2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Limit</label>
                        <select id="input-limit" class="md-input p-2 h-10">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                            <option value="500">500</option>
                            <option value="0">All</option>
                        </select>
                    </div>
                    <div class="w-1/2 flex items-end">
                        <button id="btn-generate" class="w-full bg-black text-white font-bold h-10 rounded-lg active:scale-95 transition-transform text-sm">
                            GENERATE
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Bar (Hidden by default) -->
            <div id="action-bar" class="flex justify-between items-center mb-3 hidden">
                <span class="text-xs font-bold text-gray-500" id="result-count">0 Results</span>
                <button id="btn-copy-all" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded hover:bg-blue-100">
                    <i class="far fa-copy mr-1"></i> Copy All
                </button>
            </div>

            <!-- Results List -->
            <div id="results-list" class="flex flex-col gap-2 pb-10">
                <div class="text-center text-gray-400 text-xs mt-10">
                    Enter an email to generate combinations.
                </div>
            </div>

        </main>

        <!-- DATA MODAL -->
        <div id="data-modal" class="modal-overlay">
            <div class="modal-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Smart Protection</h3>
                    <button id="btn-close-data" class="text-gray-400 hover:text-black"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="space-y-3">
                    <div class="text-xs text-gray-500 mb-2">
                        Your data is automatically saved to this browser. Use Export/Import to move data to another device.
                    </div>

                    <button onclick="exportBackup()" class="w-full bg-black text-white font-bold py-3 rounded text-sm flex justify-center items-center gap-2">
                        <i class="fas fa-download"></i> Export Data File
                    </button>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-200"></div>
                        </div>
                        <div class="relative flex justify-center text-xs">
                            <span class="px-2 bg-white text-gray-500">OR</span>
                        </div>
                    </div>

                    <div>
                        <input type="file" id="file-import" class="hidden" accept=".txt,.json">
                        <button onclick="document.getElementById('file-import').click()" class="w-full border border-gray-300 text-gray-700 font-bold py-2 rounded text-xs mb-2 hover:bg-gray-50">
                            Select File to Import
                        </button>
                        <textarea id="import-text" class="w-full border p-2 text-[10px] rounded mb-2 font-mono h-20" placeholder="Paste import code here..."></textarea>
                        <button onclick="processImport()" class="w-full bg-blue-600 text-white font-bold py-2 rounded text-xs">
                            Import Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Dark Mode Init ---
        const btnTheme = document.getElementById('btn-theme');
        if (document.documentElement.classList.contains('dark-mode')) {
            btnTheme.innerHTML = '<i class="fas fa-sun"></i>';
        }
        btnTheme.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark-mode');
            const isDark = document.documentElement.classList.contains('dark-mode');
            localStorage.setItem('shein_pcal_theme', isDark ? 'dark' : 'light');
            btnTheme.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });

        // --- Logic ---
        const inputEmail = document.getElementById('input-email');
        const inputLimit = document.getElementById('input-limit');
        const btnGenerate = document.getElementById('btn-generate');
        const resultsList = document.getElementById('results-list');
        const actionBar = document.getElementById('action-bar');
        const resultCount = document.getElementById('result-count');
        const btnCopyAll = document.getElementById('btn-copy-all');
        
        // Data Modal
        const btnData = document.getElementById('btn-data');
        const dataModal = document.getElementById('data-modal');
        const btnCloseData = document.getElementById('btn-close-data');
        const fileImport = document.getElementById('file-import');
        const importTextArea = document.getElementById('import-text');

        // Database & Session
        let db = JSON.parse(localStorage.getItem('maildot_db') || '{}');
        let session = JSON.parse(localStorage.getItem('maildot_session') || '{}');

        // Stats Elements
        const elStatToday = document.getElementById('stat-today');
        const elStatAccounts = document.getElementById('stat-accounts');
        const elStatWeek = document.getElementById('stat-week');
        const elStatTotal = document.getElementById('stat-total');

        // --- Initialization ---
        // Restore Session
        if (session.email) {
            inputEmail.value = session.email;
            inputLimit.value = session.limit || "50";
            // Auto-generate if session exists (Smart Protection)
            setTimeout(() => btnGenerate.click(), 100);
        }
        updateStats();

        // --- Event Listeners ---
        inputEmail.addEventListener('input', saveSession);
        inputLimit.addEventListener('change', saveSession);

        btnGenerate.addEventListener('click', () => {
            const email = inputEmail.value.trim();
            if (!email.includes('@')) { alert('Invalid Email'); return; }

            saveSession(); // Ensure session saved
            const limitVal = parseInt(inputLimit.value);
            let combos = getCombinations(email);

            if (limitVal > 0 && combos.length > limitVal) {
                combos = combos.slice(0, limitVal);
            }

            renderList(combos);
        });

        // Data Management Events
        btnData.addEventListener('click', () => dataModal.classList.add('show'));
        btnCloseData.addEventListener('click', () => dataModal.classList.remove('show'));
        
        fileImport.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                importTextArea.value = e.target.result;
                processImport(); // Auto process on file select
            };
            reader.readAsText(file);
        });

        // --- Functions ---

        function saveSession() {
            const s = {
                email: inputEmail.value,
                limit: inputLimit.value
            };
            localStorage.setItem('maildot_session', JSON.stringify(s));
        }

        function updateStats() {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay())).getTime();
            const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();

            let today = 0, week = 0, month = 0, total = 0, count = 0;

            Object.values(db).forEach(item => {
                count++;
                if (item.status === 'sold' && item.price) {
                    const price = parseFloat(item.price);
                    const ts = item.timestamp;
                    if (ts >= todayStart) today += price;
                    if (ts >= weekStart) week += price;
                    if (ts >= monthStart) month += price;
                    total += price;
                }
            });

            elStatToday.innerText = '₱' + today.toLocaleString();
            elStatWeek.innerText = '₱' + week.toLocaleString();
            elStatTotal.innerText = '₱' + total.toLocaleString();
            elStatAccounts.innerText = count;
        }

        function saveData(email, field, value) {
            if (!db[email]) {
                db[email] = { price: '', note: '', status: 'active', timestamp: Date.now() };
            }
            
            db[email][field] = value;
            
            if (field === 'price' && value !== '' && db[email].status === 'active') {
                // Auto active logic preserved
            }
            
            if (field === 'status' && value === 'sold') {
                db[email].timestamp = Date.now();
            }

            localStorage.setItem('maildot_db', JSON.stringify(db));
            updateStats();
        }

        function getCombinations(email) {
            const [user, domain] = email.split('@');
            if (!user || !domain) return [];

            const n = user.length - 1;
            const max = 1 << n;
            const combos = [];
            
            const safeMax = n > 15 ? 10000 : max; 

            for (let i = 0; i < safeMax; i++) {
                let str = user[0];
                for (let j = 0; j < n; j++) {
                    if ((i >> j) & 1) str += '.';
                    str += user[j + 1];
                }
                combos.push(str + '@' + domain);
            }
            return combos;
        }

        function renderList(emails) {
            resultsList.innerHTML = '';
            if (emails.length === 0) return;

            actionBar.classList.remove('hidden');
            resultCount.innerText = `${emails.length} Results`;

            emails.forEach(email => {
                const saved = db[email] || { price: '', note: '', status: 'active' };
                const isSold = saved.status === 'sold';

                const div = document.createElement('div');
                div.className = 'email-item';
                div.innerHTML = `
                    <span class="email-text" onclick="copyText(this, '${email}')">${email}</span>
                    <div class="item-controls">
                        <div class="relative w-1/4">
                            <span class="absolute left-1.5 top-1.5 text-xs text-gray-400">₱</span>
                            <input type="number" class="tiny-input w-full pl-4" placeholder="Price" 
                                value="${saved.price}" onchange="saveData('${email}', 'price', this.value)">
                        </div>
                        <input type="text" class="tiny-input flex-1" maxlength="16" placeholder="Note (16 chars)" 
                            value="${saved.note}" onchange="saveData('${email}', 'note', this.value)">
                        <button class="status-btn ${isSold ? 'status-sold' : 'status-active'}" 
                            onclick="toggleStatus(this, '${email}')">
                            ${isSold ? 'SOLD' : 'ACTIVE'}
                        </button>
                    </div>
                `;
                resultsList.appendChild(div);
            });
        }

        window.copyText = function(el, text) {
            navigator.clipboard.writeText(text).then(() => {
                el.classList.add('copied');
            });
        }

        window.toggleStatus = function(btn, email) {
            const isSold = btn.innerText === 'SOLD';
            const newStatus = isSold ? 'active' : 'sold';
            
            btn.innerText = newStatus === 'sold' ? 'SOLD' : 'ACTIVE';
            btn.className = `status-btn ${newStatus === 'sold' ? 'status-sold' : 'status-active'}`;
            
            saveData(email, 'status', newStatus);
        }

        btnCopyAll.addEventListener('click', () => {
            const emails = Array.from(document.querySelectorAll('.email-text')).map(e => e.innerText).join('\n');
            navigator.clipboard.writeText(emails).then(() => {
                btnCopyAll.innerHTML = '<i class="fas fa-check"></i> Copied';
                setTimeout(() => btnCopyAll.innerHTML = '<i class="far fa-copy mr-1"></i> Copy All', 2000);
                document.querySelectorAll('.email-text').forEach(el => el.classList.add('copied'));
            });
        });

        // --- Export / Import Helpers ---
        // UTF-8 Safe Base64
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

        window.exportBackup = function() {
            try {
                const dataStr = utf8_to_b64(JSON.stringify(db));
                const blob = new Blob([dataStr], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0,10);
                a.download = `maildot_backup_${date}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch(e) { alert("Export failed: " + e.message); }
        }

        window.processImport = function() {
            const code = importTextArea.value.trim();
            if (!code) { alert("Please paste code or select a file."); return; }
            try {
                const jsonStr = b64_to_utf8(code);
                const importedData = JSON.parse(jsonStr);
                
                if (typeof importedData !== 'object') throw new Error();

                // Merge: Overwrite local with imported if match, keep local if not in import
                db = { ...db, ...importedData };
                localStorage.setItem('maildot_db', JSON.stringify(db));
                updateStats();
                
                // Refresh list if current email matches any imported data
                if (inputEmail.value) btnGenerate.click();

                alert("Data imported successfully!");
                dataModal.classList.remove('show');
                importTextArea.value = "";
                fileImport.value = "";
            } catch (e) {
                alert("Invalid Import Code or File Format.");
            }
        }

    </script>
</body>
</html>
